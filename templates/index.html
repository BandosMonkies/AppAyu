<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MediScan AI - Advanced Health Analysis</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏥</text></svg>">
</head>
<body>

  <div class="container">
    <header class="hero">
      <div class="hero-text">
        <h1>🏥 MediScan AI</h1>
        <p>Advanced AI-powered health image analysis for accurate medical insights. Upload your medical image and get instant, professional-grade analysis with treatment recommendations.<br><small>⚠️ For educational purposes only - Always consult a qualified healthcare professional</small></p>
      </div>
    </header>
    <div id="patientInfo" class="patient-info">
      <h3>👤 Patient Information</h3>
      <div id="patientDetails">Loading patient details...</div>
    </div>

    <div class="layout">
      <section class="left-card card">
        <h2>📤 Upload & Analysis</h2>
        <p class="muted">Upload your medical image and select the appropriate category for AI analysis</p>

        <div class="upload-box">
          <label class="file-label">
            <input type="file" id="fileInput" accept="image/*">
            <span class="file-btn">📷 Choose Medical Image</span>
          </label>

          <div class="controls">
            <label for="categorySelect" class="select-label">Medical Category</label>
            <select id="categorySelect" aria-label="Medical category select">
              <option value="skin">🩺 Dermatology (Skin)</option>
              <option value="eye">👁️ Ophthalmology (Eye)</option>
              <option value="oral">🦷 Oral Health</option>
              <option value="other">🔬 Other Medical Issue</option>
            </select>
            
            <label for="languageSelect" class="select-label">🌐 Output Language</label>
            <select id="languageSelect" aria-label="Language selection">
              <option value="en">🇺🇸 English</option>
              <option value="hi">🇮🇳 Hindi (हिंदी)</option>
              <option value="kn">🇮🇳 Kannada (ಕನ್ನಡ)</option>
            </select>
            <small class="muted">Note: Translation requires Google Cloud Translation API key configuration</small>
            
            <button id="detectBtn" class="primary">🔍 Analyze Image</button>
          </div>

            <div class="extras">
              <label for="ageInput">👤 Patient Age (optional)</label>
              <input id="ageInput" type="number" min="0" max="120" placeholder="Enter patient age (e.g. 35)" />

              <label for="extraInfo">📝 Additional Medical Information (optional)</label>
              <textarea id="extraInfo" rows="4" placeholder="Please provide any relevant medical history, symptoms duration, current medications, or other important details that might help with the analysis..."></textarea>
            </div>

          <div class="preview-wrap">
            <img id="preview" src="" alt="Medical image preview will appear here">
            <p id="previewHint" class="muted small">🖼️ Image Preview</p>
          </div>
        </div>
      </section>

      <section class="right-card card">
        <!-- Severe Alert Banner -->
        <div id="severeAlert" class="severe-alert hidden">
          <div class="severe-alert-content">
            <h2>🚨 URGENT MEDICAL ATTENTION REQUIRED 🚨</h2>
            <p><strong>Please contact emergency medical services immediately!</strong></p>
            <p>This condition requires immediate professional medical attention. Do not delay seeking emergency healthcare.</p>
          </div>
        </div>

        <div id="result" class="result-box hidden">
          <h2>🔬 AI Analysis Results</h2>
          <p><strong>Condition Detected:</strong> <span id="disease"></span></p>
          <!-- <p><strong>Confidence:</strong> <span id="confidence"></span>%</p> -->
          <div class="disease-info">
            <div class="analysis-box">
              <h3>🔍 Image Analysis Details</h3>
              <p><strong>Color Characteristics:</strong> <span id="colorTone"></span></p>
              <p><strong>Surface Texture:</strong> <span id="texture"></span></p>
              <p><strong>Image Quality:</strong> <span id="imageSize"></span></p>
            </div>
            <p><strong>Medical Description:</strong> <span id="description"></span></p>
            <p><strong>Severity Assessment:</strong> <span id="severity"></span></p>
            <div class="treatments">
              <p><strong>💊 Recommended Treatment:</strong></p>
              <ul id="treatments"></ul>
            </div>
            <div class="disclaimer">
              <p><strong>⚠️ Important Medical Disclaimer:</strong> <em>This AI analysis is for educational and preliminary screening purposes only. It should never replace professional medical diagnosis. Always consult a qualified healthcare professional for proper diagnosis, treatment, and medical advice.</em></p>
            </div>
          </div>
        </div>
        <div id="resultPlaceholder" class="placeholder">
          <p class="muted">🔄 Ready for analysis. Upload a medical image and click "Analyze Image" to begin.</p>
        </div>
      </section>
    </div>
  </div>

  <script>
    let currentPatient = null;
    let currentAshaWorker = null;
    
    // Load patient info and ASHA worker info from localStorage
    window.addEventListener('DOMContentLoaded', () => {
      const patientJson = localStorage.getItem('currentPatient');
      if (!patientJson) {
        // No patient selected -> go back to home to select/create
        window.location.href = '/';
        return;
      }

      try {
        const parsed = JSON.parse(patientJson);
        // Normalize name field (backend may return `username` or `name`)
        const displayName = parsed.name || parsed.username || parsed.username || parsed.fullname || 'Unknown';
        const phone = parsed.phone || parsed.phone || 'Unknown';
        currentPatient = { name: displayName, phone };

        const detailsEl = document.getElementById('patientDetails');
        // Replace content (prevents accidental duplicated append)
        detailsEl.innerHTML = `\n          <p><strong>Name:</strong> ${currentPatient.name}</p>\n          <p><strong>Phone:</strong> ${currentPatient.phone}</p>\n        `;
      } catch (err) {
        console.error('Failed to parse patient data from storage', err);
        window.location.href = '/';
        return;
      }

      // Load ASHA worker info from localStorage
      try {
        const currentUserMobile = localStorage.getItem('ayuscan_current_user_v1');
        if (!currentUserMobile) {
          alert('No ASHA worker logged in. Please login first.');
          window.location.href = '/';
          return;
        }

        const users = JSON.parse(localStorage.getItem('ayuscan_users_v1') || '{}');
        const ashaWorker = users[currentUserMobile];
        
        if (!ashaWorker) {
          alert('ASHA worker information not found. Please login again.');
          window.location.href = '/';
          return;
        }

        // Store ASHA worker info for later use
        currentAshaWorker = {
          name: ashaWorker.name,
          ashaId: ashaWorker.ashaId,
          mobile: ashaWorker.mobile
        };
        
        console.log('Logged in ASHA Worker:', currentAshaWorker);
      } catch (err) {
        console.error('Failed to load ASHA worker data from storage', err);
        alert('Error loading ASHA worker information. Please login again.');
        window.location.href = '/';
      }
    });

    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const detectBtn = document.getElementById('detectBtn');
    const resultBox = document.getElementById('result');
  const diseaseText = document.getElementById('disease');
    // const confidenceText = document.getElementById('confidence');
    const descriptionText = document.getElementById('description');
    const severityText = document.getElementById('severity');
    const treatmentsList = document.getElementById('treatments');
    const colorToneText = document.getElementById('colorTone');
    const textureText = document.getElementById('texture');
    const imageSizeText = document.getElementById('imageSize');
  const ageInput = document.getElementById('ageInput');
  const extraInfo = document.getElementById('extraInfo');

  let selectedFile;
  const categorySelect = document.getElementById('categorySelect');
  const previewHint = document.getElementById('previewHint');
  const resultPlaceholder = document.getElementById('resultPlaceholder');

    fileInput.addEventListener('change', () => {
      selectedFile = fileInput.files[0];
      if (selectedFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.src = e.target.result;
          preview.style.display = 'block';
          previewHint.style.display = 'block';
        };
        reader.readAsDataURL(selectedFile);
      }
    });

    detectBtn.addEventListener('click', async () => {
      if (!selectedFile) {
        alert('Please upload an image first!');
        return;
      }

  const formData = new FormData();
  formData.append('file', selectedFile);
  // include selected category
  formData.append('category', categorySelect ? categorySelect.value : 'skin');
  // include selected language
  const languageSelect = document.getElementById('languageSelect');
  formData.append('language', languageSelect ? languageSelect.value : 'en');
  // include patient info
  formData.append('patient_name', currentPatient.name);
  formData.append('patient_phone', currentPatient.phone);
  // include optional user info
  if (ageInput && ageInput.value) formData.append('age', ageInput.value);
  if (extraInfo && extraInfo.value) formData.append('extra_info', extraInfo.value);
  // include ASHA worker info from logged-in user
  if (currentAshaWorker) {
    formData.append('asha_worker_name', currentAshaWorker.name);
    formData.append('asha_worker_id', currentAshaWorker.ashaId);
    formData.append('asha_worker_mobile', currentAshaWorker.mobile);
  }

      detectBtn.innerHTML = '<span class="loading"></span> Analyzing...';
      detectBtn.disabled = true;

      try {
        const response = await fetch('/predict', { method: 'POST', body: formData });
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

  detectBtn.innerHTML = '🔍 Analyze Image';
        detectBtn.disabled = false;

        // Update basic information with fallbacks
        diseaseText.textContent = data.disease || 'Unknown';
        // confidenceText.textContent = data.confidence || 0;
        descriptionText.textContent = data.description || 'No description available';
        // severity text and color
        const severityValue = data.severity || 'Unknown';
        severityText.textContent = severityValue;
        // set color class depending on severity
        const sev = (severityValue || '').toString().toLowerCase();
        severityText.className = '';
        if (sev.includes('high') || sev.includes('severe')) {
          severityText.classList.add('severity-high');
        } else if (sev.includes('medium') || sev.includes('moderate')) {
          severityText.classList.add('severity-medium');
        } else {
          // default: low/very low/unknown -> green
          severityText.classList.add('severity-low');
        }
        
        // Check if severity is severe and show alert
        const isSevere = sev.includes('severe');
        const severeAlert = document.getElementById('severeAlert');
        const treatmentsContainer = treatmentsList.closest('.treatments');
        
        if (isSevere) {
          // Show severe alert
          severeAlert.classList.remove('hidden');
          
          // Hide and replace treatments with contact doctor message
          treatmentsContainer.innerHTML = '';
          const contactDoctorDiv = document.createElement('div');
          contactDoctorDiv.className = 'contact-doctor-message';
          contactDoctorDiv.innerHTML = `
            <p><strong style="color: #dc2626; font-size: 1.2rem;">⚠️ Medical Attention Required</strong></p>
            <p style="color: #991b1b; font-weight: 600;">Please contact a doctor immediately for proper diagnosis and treatment.</p>
            <p style="margin-top: 10px; color: #b91c1c;">This condition requires immediate professional medical care.</p>
          `;
          treatmentsContainer.appendChild(contactDoctorDiv);
          
          // Add click handler to close the alert
          severeAlert.addEventListener('click', function(e) {
            if (e.target === severeAlert) {
              severeAlert.classList.add('hidden');
            }
          });
        } else {
          // Hide severe alert and show normal treatments
          severeAlert.classList.add('hidden');
          
          treatmentsContainer.innerHTML = '<p><strong>Recommended Medicines:</strong></p><ul id="treatments"></ul>';
          const treatmentsList = document.getElementById('treatments');
          
          // Clear and update medicines list with fallback
          treatmentsList.innerHTML = '';
          if (Array.isArray(data.medicines) && data.medicines.length > 0) {
            data.medicines.forEach(medicine => {
              const li = document.createElement('li');
              li.textContent = medicine;
              treatmentsList.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.textContent = 'No specific medicines provided';
            treatmentsList.appendChild(li);
          }
        }
        
        // Update analysis information with fallbacks
        if (data.analysis) {
          colorToneText.textContent = data.analysis.color_tone || 'Not analyzed';
          textureText.textContent = data.analysis.texture || 'Not analyzed';
          imageSizeText.textContent = data.analysis.size || 'Not analyzed';
        } else {
          colorToneText.textContent = 'Not analyzed';
          textureText.textContent = 'Not analyzed';
          imageSizeText.textContent = 'Not analyzed';
        }
      } catch (error) {
        detectBtn.innerHTML = '🔍 Analyze Image';
        detectBtn.disabled = false;
        alert('❌ Error analyzing image: ' + error.message);
        return;
      }
      
  resultBox.classList.remove('hidden');
  if (resultPlaceholder) resultPlaceholder.style.display = 'none';
    });
  </script>
</body>
</html>
