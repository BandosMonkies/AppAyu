<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skin Disease Detector</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <div class="container">
    <header class="hero">
      <div class="hero-text">
        <h1>AI Health Image Analyzer</h1>
        <p>Upload an image and select the issue category &mdash; the AI will provide an analysis and suggested next steps.<br><small>(Educational use only &mdash; consult a professional)</small></p>
      </div>
    </header>
    <div id="patientInfo" class="card" style="margin-bottom: 20px; padding: 15px;">
      <h3>Patient Information</h3>
      <div id="patientDetails">Loading patient details...</div>
    </div>

    <div class="layout">
      <section class="left-card card">
        <h2>Upload & Options</h2>
        <p class="muted">Choose an image and the relevant issue type</p>

        <div class="upload-box">
          <label class="file-label">
            <input type="file" id="fileInput" accept="image/*">
            <span class="file-btn">Choose Image</span>
          </label>

          <div class="controls">
            <label for="categorySelect" class="select-label">Issue type</label>
            <select id="categorySelect" aria-label="Issue type select">
              <option value="other">other issue</option>
              <option value="eye">Eye related issue</option>
              <option value="oral">Oral related issue</option>
              <option value="skin">skin</option>
            </select>
            <button id="detectBtn" class="primary">Detect</button>
          </div>

            <div class="extras">
              <label for="ageInput" class="small">Age (optional)</label>
              <input id="ageInput" type="number" min="0" placeholder="e.g. 35" />

              <label for="extraInfo" class="small">Extra information (optional)</label>
              <textarea id="extraInfo" rows="3" placeholder="Any relevant notes (duration, symptoms, medical history)"></textarea>
            </div>

          <div class="preview-wrap">
            <img id="preview" src="" alt="Preview will appear here">
            <p id="previewHint" class="muted small">Preview</p>
          </div>
        </div>
      </section>

      <section class="right-card card">
        <!-- Severe Alert Banner -->
        <div id="severeAlert" class="severe-alert hidden">
          <div class="severe-alert-content">
            <h2>üö® SEVERE CONDITION DETECTED üö®</h2>
            <p><strong>Please contact a doctor immediately!</strong></p>
            <p>This condition requires immediate medical attention. Do not delay seeking professional healthcare.</p>
          </div>
        </div>

        <div id="result" class="result-box hidden">
      <h2>Prediction Result</h2>
      <p><strong>Disease:</strong> <span id="disease"></span></p>
      <!-- <p><strong>Confidence:</strong> <span id="confidence"></span>%</p> -->
      <div class="disease-info">
        <div class="analysis-box">
          <h3>Image Analysis</h3>
          <p><strong>Color Tone:</strong> <span id="colorTone"></span></p>
          <p><strong>Texture:</strong> <span id="texture"></span></p>
          <p><strong>Image Size:</strong> <span id="imageSize"></span></p>
        </div>
        <p><strong>Description:</strong> <span id="description"></span></p>
        <p><strong>Severity Level:</strong> <span id="severity"></span></p>
        <div class="treatments">
          <p><strong>Recommended Medicines:</strong></p>
          <ul id="treatments"></ul>
        </div>
        <div class="disclaimer">
          <p><strong>Warning:</strong> <em>This is an AI-powered prediction tool for educational purposes only. Please consult a qualified healthcare professional for proper diagnosis and treatment.</em></p>
        </div>
      </div>
        </div>
        <div id="resultPlaceholder" class="placeholder">
          <p class="muted">No analysis yet. Upload an image and press Detect.</p>
        </div>
      </section>
    </div>
  </div>

  <script>
    let currentPatient = null;
    
    // Load patient info from localStorage (normalize fields)
    window.addEventListener('DOMContentLoaded', () => {
      const patientJson = localStorage.getItem('currentPatient');
      if (!patientJson) {
        // No patient selected -> go back to home to select/create
        window.location.href = '/';
        return;
      }

      try {
        const parsed = JSON.parse(patientJson);
        // Normalize name field (backend may return `username` or `name`)
        const displayName = parsed.name || parsed.username || parsed.username || parsed.fullname || 'Unknown';
        const phone = parsed.phone || parsed.phone || 'Unknown';
        currentPatient = { name: displayName, phone };

        const detailsEl = document.getElementById('patientDetails');
        // Replace content (prevents accidental duplicated append)
        detailsEl.innerHTML = `\n          <p><strong>Name:</strong> ${currentPatient.name}</p>\n          <p><strong>Phone:</strong> ${currentPatient.phone}</p>\n        `;
      } catch (err) {
        console.error('Failed to parse patient data from storage', err);
        window.location.href = '/';
      }
    });

    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const detectBtn = document.getElementById('detectBtn');
    const resultBox = document.getElementById('result');
  const diseaseText = document.getElementById('disease');
    // const confidenceText = document.getElementById('confidence');
    const descriptionText = document.getElementById('description');
    const severityText = document.getElementById('severity');
    const treatmentsList = document.getElementById('treatments');
    const colorToneText = document.getElementById('colorTone');
    const textureText = document.getElementById('texture');
    const imageSizeText = document.getElementById('imageSize');
  const ageInput = document.getElementById('ageInput');
  const extraInfo = document.getElementById('extraInfo');

  let selectedFile;
  const categorySelect = document.getElementById('categorySelect');
  const previewHint = document.getElementById('previewHint');
  const resultPlaceholder = document.getElementById('resultPlaceholder');

    fileInput.addEventListener('change', () => {
      selectedFile = fileInput.files[0];
      if (selectedFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.src = e.target.result;
          preview.style.display = 'block';
          previewHint.style.display = 'block';
        };
        reader.readAsDataURL(selectedFile);
      }
    });

    detectBtn.addEventListener('click', async () => {
      if (!selectedFile) {
        alert('Please upload an image first!');
        return;
      }

  const formData = new FormData();
  formData.append('file', selectedFile);
  // include selected category
  formData.append('category', categorySelect ? categorySelect.value : 'skin');
  // include patient info
  formData.append('patient_name', currentPatient.name);
  formData.append('patient_phone', currentPatient.phone);
  // include optional user info
  if (ageInput && ageInput.value) formData.append('age', ageInput.value);
  if (extraInfo && extraInfo.value) formData.append('extra_info', extraInfo.value);

      detectBtn.textContent = 'Detecting...';
      detectBtn.disabled = true;

      try {
        const response = await fetch('/predict', { method: 'POST', body: formData });
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

  detectBtn.textContent = 'üîç Detect';
        detectBtn.disabled = false;

        // Update basic information with fallbacks
        diseaseText.textContent = data.disease || 'Unknown';
        // confidenceText.textContent = data.confidence || 0;
        descriptionText.textContent = data.description || 'No description available';
        // severity text and color
        const severityValue = data.severity || 'Unknown';
        severityText.textContent = severityValue;
        // set color class depending on severity
        const sev = (severityValue || '').toString().toLowerCase();
        severityText.className = '';
        if (sev.includes('high') || sev.includes('severe')) {
          severityText.classList.add('severity-high');
        } else if (sev.includes('medium') || sev.includes('moderate')) {
          severityText.classList.add('severity-medium');
        } else {
          // default: low/very low/unknown -> green
          severityText.classList.add('severity-low');
        }
        
        // Check if severity is severe and show alert
        const isSevere = sev.includes('severe');
        const severeAlert = document.getElementById('severeAlert');
        const treatmentsContainer = treatmentsList.closest('.treatments');
        
        if (isSevere) {
          // Show severe alert
          severeAlert.classList.remove('hidden');
          
          // Hide and replace treatments with contact doctor message
          treatmentsContainer.innerHTML = '';
          const contactDoctorDiv = document.createElement('div');
          contactDoctorDiv.className = 'contact-doctor-message';
          contactDoctorDiv.innerHTML = `
            <p><strong style="color: #dc2626; font-size: 1.2rem;">‚ö†Ô∏è Medical Attention Required</strong></p>
            <p style="color: #991b1b; font-weight: 600;">Please contact a doctor immediately for proper diagnosis and treatment.</p>
            <p style="margin-top: 10px; color: #b91c1c;">This condition requires immediate professional medical care.</p>
          `;
          treatmentsContainer.appendChild(contactDoctorDiv);
          
          // Add click handler to close the alert
          severeAlert.addEventListener('click', function(e) {
            if (e.target === severeAlert) {
              severeAlert.classList.add('hidden');
            }
          });
        } else {
          // Hide severe alert and show normal treatments
          severeAlert.classList.add('hidden');
          
          treatmentsContainer.innerHTML = '<p><strong>Recommended Medicines:</strong></p><ul id="treatments"></ul>';
          const treatmentsList = document.getElementById('treatments');
          
          // Clear and update medicines list with fallback
          treatmentsList.innerHTML = '';
          if (Array.isArray(data.medicines) && data.medicines.length > 0) {
            data.medicines.forEach(medicine => {
              const li = document.createElement('li');
              li.textContent = medicine;
              treatmentsList.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.textContent = 'No specific medicines provided';
            treatmentsList.appendChild(li);
          }
        }
        
        // Update analysis information with fallbacks
        if (data.analysis) {
          colorToneText.textContent = data.analysis.color_tone || 'Not analyzed';
          textureText.textContent = data.analysis.texture || 'Not analyzed';
          imageSizeText.textContent = data.analysis.size || 'Not analyzed';
        } else {
          colorToneText.textContent = 'Not analyzed';
          textureText.textContent = 'Not analyzed';
          imageSizeText.textContent = 'Not analyzed';
        }
      } catch (error) {
        detectBtn.textContent = 'üîç Detect Disease';
        detectBtn.disabled = false;
        alert('Error analyzing image: ' + error.message);
        return;
      }
      
  resultBox.classList.remove('hidden');
  if (resultPlaceholder) resultPlaceholder.style.display = 'none';
    });
  </script>
</body>
</html>
